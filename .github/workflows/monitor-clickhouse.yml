name: Monitor ClickHouse Errors

on:
  schedule:
    # Every hour at the top of the hour
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  check-errors:
    runs-on: ubuntu-latest
    steps:
      - name: Query ClickHouse for OOM and critical errors
        env:
          CLICKHOUSE_HOST: ${{ secrets.CLICKHOUSE_HOST }}
          CLICKHOUSE_USER: ${{ secrets.CLICKHOUSE_MONITORING_USER }}
          CLICKHOUSE_PASSWORD: ${{ secrets.CLICKHOUSE_MONITORING_PASSWORD }}
        run: |
          QUERY=$(cat <<'SQL'
          SELECT
              exception_code,
              user,
              count() as cnt,
              any(substring(exception, 1, 300)) as sample_error,
              any(substring(query, 1, 200)) as sample_query
          FROM system.query_log
          WHERE type = 'ExceptionWhileProcessing'
            AND exception_code IN (
              241,  -- MEMORY_LIMIT_EXCEEDED
              242,  -- TABLE_SIZE_EXCEEDED
              243   -- QUERY_WAS_CANCELLED (often memory-related)
            )
            AND event_time > now() - INTERVAL 65 MINUTE
            AND user NOT IN ('operator-internal', 'monitoring-internal', 'observability-internal')
          GROUP BY exception_code, user
          FORMAT JSONEachRow
          SQL
          )

          RESULT=$(curl -sf "https://${CLICKHOUSE_HOST}:8443/" \
            -u "${CLICKHOUSE_USER}:${CLICKHOUSE_PASSWORD}" \
            --data "$QUERY")

          if [ -z "$RESULT" ]; then
            echo "No critical errors found in the last hour."
            echo "has_errors=false" >> "$GITHUB_ENV"
          else
            echo "Critical errors detected:"
            echo "$RESULT" | jq .
            echo "has_errors=true" >> "$GITHUB_ENV"
            echo "$RESULT" > /tmp/errors.jsonl
          fi

      - name: Create or update GitHub Issue
        if: env.has_errors == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ERRORS=$(cat /tmp/errors.jsonl)

          TABLE_ROWS=$(echo "$ERRORS" | jq -r '"| \(.exception_code) | \(.user) | \(.cnt) | \(.sample_error | gsub("[\\n\\r]"; " ") | .[0:120]) |"')
          SAMPLE_QUERIES=$(echo "$ERRORS" | jq -r '.sample_query' | head -5)
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M UTC')

          cat > /tmp/issue-body.md <<ISSUE_EOF
          ## ClickHouse Critical Errors Detected

          The hourly monitoring check found critical errors in \`system.query_log\`.

          **Time window**: last 65 minutes (as of ${TIMESTAMP})

          ### Errors

          | Exception Code | User | Count | Sample Error |
          |---|---|---|---|
          ${TABLE_ROWS}

          ### Error Codes Reference

          | Code | Name | Description |
          |---|---|---|
          | 241 | MEMORY_LIMIT_EXCEEDED | Query exceeded memory limit (OOM) |
          | 242 | TABLE_SIZE_EXCEEDED | Table size limit exceeded |
          | 243 | QUERY_WAS_CANCELLED | Query cancelled (often memory-related) |

          ### Sample Queries

          \`\`\`
          ${SAMPLE_QUERIES}
          \`\`\`

          ---
          *Auto-generated by [monitor-clickhouse](${RUN_URL}) workflow.*
          ISSUE_EOF

          # Remove leading whitespace from heredoc lines
          sed -i 's/^          //' /tmp/issue-body.md

          # Check for an existing open issue with the clickhouse-oom label
          EXISTING=$(gh issue list \
            --repo "${{ github.repository }}" \
            --label "clickhouse-oom" \
            --state open \
            --limit 1 \
            --json number \
            --jq '.[0].number // empty')

          if [ -n "$EXISTING" ]; then
            gh issue comment "$EXISTING" \
              --repo "${{ github.repository }}" \
              --body-file /tmp/issue-body.md
            echo "Updated existing issue #${EXISTING}"
          else
            gh label create "clickhouse-oom" \
              --repo "${{ github.repository }}" \
              --description "ClickHouse OOM or critical error alert" \
              --color "D93F0B" \
              2>/dev/null || true

            gh issue create \
              --repo "${{ github.repository }}" \
              --title "ClickHouse critical errors detected ($(date -u '+%Y-%m-%d'))" \
              --body-file /tmp/issue-body.md \
              --label "clickhouse-oom"
            echo "Created new issue"
          fi
